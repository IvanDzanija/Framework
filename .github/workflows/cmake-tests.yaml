name: MafLib Tests
on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    build-and-test:
        strategy:
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]
        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            # Linux setup (Unchanged)
            - name: Install dependencies (Linux)
              if: runner.os == 'Linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y clang ninja-build cmake libomp-dev

            # Windows setup (ADJUSTED)
            # Replaced 'choco' install with the official 'llvm/setup-llvm' action.
            # This correctly installs Clang, OpenMP, and (critically) exports
            # the 'LLVM_PATH' env variable we need later.
            - name: Install dependencies (Windows)
              if: runner.os == 'Windows'
              uses: llvm/setup-llvm@v1
              with:
                  # Using version 18, a recent stable release.
                  # You can change this to match your project's needs.
                  version: 18
                  # Ensures 'clang' and the 'openmp' runtime/libs are installed
                  components: 'clang, openmp'

            # macOS setup (Unchanged)
            - name: Install dependencies (macOS)
              if: runner.os == 'macOS'
              run: |
                  brew update
                  brew install cmake ninja llvm libomp
                  echo "Adding Apple Clang to PATH"
                  echo "$(brew --prefix llvm)/bin" >> $GITHUB_PATH

            # Configure (CMake preset) (ADJUSTED)
            - name: Configure (clang-debug preset)
              # This 'env' block is the key to fixing the Windows error.
              env:
                  # On Windows, this sets CMAKE_PREFIX_PATH to the directory
                  # where 'setup-llvm' installed OpenMP, so 'find_package' can find it.
                  # On Linux/macOS, 'env.LLVM_PATH' is empty, so this does nothing.
                  CMAKE_PREFIX_PATH: ${{ env.LLVM_PATH }}
              run: cmake --preset clang-debug

            # ‚öôÔ∏è Build (Unchanged)
            - name: Build
              run: cmake --build --preset clang-debug --parallel

            # üß™ Run tests (Unchanged)
            - name: Run tests
              run: ctest --preset clang-debug --output-on-failure
